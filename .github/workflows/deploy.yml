name: Deploy

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Sonataflow
        uses: actions/checkout@v4
        with:
          repository: apache/incubator-kie-kogito-docs
          ref: 10.0.x
          path: sonataflow-docs

      - name: Build Sonataflow
        run: |
          cd sonataflow-docs
          npm run install-build

      - name: Checkout Apache KIE Website
        uses: actions/checkout@v4
        with:
          path: apache-kie-website

      - name: Checkout & Build Website
        uses: actions/checkout@v4
        with:
          path: site

      - name: Copy Sonataflow docs to Apache KIE static folder
        run: |
          mkdir -p site/static/sonataflow-docs
          cp -r sonataflow-docs/build/site/* site/static/sonataflow-docs

      - name : Build Apache Kie Website
        run: |
          cd site
          npm install
          npm run build
          cp .asf.yaml build/.asf.yaml

      - name: Deploy Apache KIE Website
        uses: peaceiris/actions-gh-pages@v3
        if: github.event_name != 'pull_request'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          publish_branch: deploy
