name: Deploy

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Sonataflow repository
        uses: actions/checkout@v4
        with:
          repository: apache/incubator-kie-kogito-docs
          ref: 10.0.x
          path: sonataflow-docs

      - name: Build Sonataflow documentation
        run: |
          cd sonataflow-docs
          npm run install-build

      - name: Checkout Drools repository
        uses: actions/checkout@v4
        with:
          repository: apache/incubator-kie-drools
          ref: 10.0.x
          path: drools

      - name: Build Drools documentation
        run: |
          cd drools/drools-docs
          mvn -B clean install

      - name: Checkout Apache KIE Website repository
        uses: actions/checkout@v4
        with:
          path: incubator-kie-website

      - name: Copy Sonataflow docs to Apache KIE static folder
        run: |
          mkdir -p incubator-kie-website/static/sonataflow-docs
          cp -r sonataflow-docs/build/site/* incubator-kie-website/static/sonataflow-docs

      - name: Copy Drools docs to Apache KIE static folder
        run: |
          mkdir -p incubator-kie-website/static/drools-docs
          cp -r drools/drools-docs/target/website/docs/* incubator-kie-website/static/drools-docs

      - name : Build Apache Kie Website
        run: |
          cd incubator-kie-website
          npm install
          npm run build
          cp .asf.yaml build/.asf.yaml

      - name: Preview Apache KIE Website
        uses: peaceiris/actions-gh-pages@v3
        if: github.event_name == 'pull_request'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          destination_dir: ./preview-${{ github.event.pull_request.number }}
          publish_dir: ./build

      - name : Add PR comment with preview link
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          script: |
            const { data, pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });
            const previewUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/preview/${context.payload.pull_request.number}/`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `:rocket: Preview your changes here:[${previewUrl}](${previewUrl})`
            });

      - name: Deploy Apache KIE Website
        uses: peaceiris/actions-gh-pages@v3
        if: github.event_name != 'pull_request'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          publish_branch: deploy
